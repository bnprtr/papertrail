name: publish

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  tag-and-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine whether this is a release commit
        id: rel
        shell: bash
        run: |
          set -euo pipefail
          if git show --name-only --pretty='' HEAD | grep -qx '.release-version'; then
            echo ".release-version changed in this commit; treating as release publish trigger."
          else
            echo ".release-version not changed in this commit; skipping publish."
            echo "is_release=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ -f .release-version ]]; then
            VERSION="$(cat .release-version | tr -d '\n' | tr -d '\r')"
            if [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "is_release=true" >> "$GITHUB_OUTPUT"
              echo "version=$VERSION" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi
          echo "is_release=false" >> "$GITHUB_OUTPUT"

      - name: Ensure tag does not already exist
        if: steps.rel.outputs.is_release == 'true'
        id: tagcheck
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.rel.outputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "tag_exists=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "tag_exists=false" >> "$GITHUB_OUTPUT"

      - name: Create tag
        if: steps.rel.outputs.is_release == 'true' && steps.tagcheck.outputs.tag_exists != 'true'
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.rel.outputs.version }}"
          git tag "$VERSION"
          git push origin "$VERSION"

      - name: Build binaries
        if: steps.rel.outputs.is_release == 'true' && steps.tagcheck.outputs.tag_exists != 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          platforms=("linux/amd64" "linux/arm64" "darwin/amd64" "darwin/arm64" "windows/amd64")
          for platform in "${platforms[@]}"; do
            platform_split=(${platform//\// })
            GOOS=${platform_split[0]}
            GOARCH=${platform_split[1]}
            output_name="papertrail-${GOOS}-${GOARCH}"
            if [ $GOOS = "windows" ]; then
              output_name+=".exe"
            fi
            echo "Building $output_name..."
            GOOS=$GOOS GOARCH=$GOARCH go build -o "dist/$output_name" ./cmd/papertrail
          done

      - name: Create GitHub Release
        if: steps.rel.outputs.is_release == 'true' && steps.tagcheck.outputs.tag_exists != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.rel.outputs.version }}
          body_path: .release-notes.md
          files: dist/*

